<!DOCTYPE html>
<html>

<head>
    <title>Sensor Logger Live Plot</title>
</head>

<body>
    <h2>Scan this code with your mobile, import into Sensor Logger and start recording: <br>
    </h2>
    <br>
    <img src="{{ qrcode(config_img, back_color='white', fill_color='black',
        box_size=10,border=4) }}" width="500" height="500">
    <br>
    <div id="plotsession">
    </div>
    <div id="status">
    </div>
    <br>
    <h3>{{ cchdr }}</h3>
    <pre>{{ config }}
    </pre>
    <br>

    <script>
        const session = "{{ clientsession }}";
        document.getElementById("status").innerHTML = "<h2>waiting for Sensorlogger ..</h2>";
        const uri = "ws://" + window.location.host + "/waitfor/" + session;
        const socket = new WebSocket(uri);

        // notify we're alive and listening
        socket.onopen = function (ev) {
            this.send('{ "hello": "' + session + '"}');
        };
        const destUri = "http://" + window.location.host + "{{tppath}}?session=" + session + "&udp_port={{udp_port}}";
        document.getElementById("plotsession").innerHTML =  "<a href=" + destUri + "  > shareable link to Teleplot session </a>";

        socket.onmessage = function (ev) {
            console.log(ev.data);
            if (ev.data === "goahead") {
                document.getElementById("status").innerHTML = "<h2>starting Teleplot</h2>";
                this.close(1000, "got goahead");
                window.location = destUri; 
            }
        };
    </script>
</body>

</html>